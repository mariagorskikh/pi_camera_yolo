{% extends 'base.html' %}

{% block header %}
    {% block title %}Server Settings{% endblock %}
{% endblock %}

{% block content %}
    <div id="settingsmenubar" class="w3-bar w3-green">
        <!-- Settings menue -->
        {% if sc.lastSettingsTab == "settingsparams" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsgparamsbtn"
            onclick="openSettingsTab('settingsparams', 'settingsgparamsbtn')">Parameters</button>
        {% else %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsgparamsbtn"
            onclick="openSettingsTab('settingsparams', 'settingsgparamsbtn')">Parameters</button>
        {% endif %}
        {% if sc.lastSettingsTab == "settingsconfig" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsconfigbtn"
            onclick="openSettingsTab('settingsconfig', 'settingsconfigbtn')">Configuration</button>
        {% else %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsconfigbtn"
            onclick="openSettingsTab('settingsconfig', 'settingsconfigbtn')">Configuration</button>
        {% endif %}
        {% if sc.lastSettingsTab == "settingsusers" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsusersbtn"
            onclick="openSettingsTab('settingsusers', 'settingsusersbtn')">Users</button>
        {% else %}
        {% set activeuser = g.user %}
        {% if activeuser["issuperuser"] == 1 %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsusersbtn"
            onclick="openSettingsTab('settingsusers', 'settingsusersbtn')">Users</button>
        {% endif %}
        {% endif %}
        {% if sc.lastSettingsTab == "settingsapi" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsapibtn"
            onclick="openSettingsTab('settingsapi', 'settingsapibtn')">API</button>
        {% else %}
        {% if sc.useAPI == True %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsapibtn"
            onclick="openSettingsTab('settingsapi', 'settingsapibtn')">API</button>
        {% endif %}
        {% endif %}
        {% if sc.lastSettingsTab == "settingsvbuttons" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsvbuttonsbtn"
            onclick="openSettingsTab('settingsvbuttons', 'settingsvbuttonsbtn')">Versatile Buttons</button>
        {% else %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsvbuttonsbtn"
            onclick="openSettingsTab('settingsvbuttons', 'settingsvbuttonsbtn')">Versatile Buttons</button>
        {% endif %}
        {% if sc.lastSettingsTab == "settingsabuttons" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsabuttonsbtn"
            onclick="openSettingsTab('settingsabuttons', 'settingsabuttonsbtn')">Action Buttons</button>
        {% else %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsabuttonsbtn"
            onclick="openSettingsTab('settingsabuttons', 'settingsabuttonsbtn')">Action Buttons</button>
        {% endif %}
        {% if sc.lastSettingsTab == "settingsdevices" %}
        <button class="w3-bar-item w3-button settingsmenu w3-light-green" id="settingsdevicesbtn"
            onclick="openSettingsTab('settingsdevices', 'settingsdevicesbtn')">Devices</button>
        {% else %}
        <button class="w3-bar-item w3-button settingsmenu" id="settingsdevicesbtn"
            onclick="openSettingsTab('settingsdevices', 'settingsdevicesbtn')">Devices</button>
        {% endif %}
        <div class="w3-bar-item w3-right" style="padding-top:2px; padding-bottom:0">
            <div class="w3-tooltip">
                <span style="position:absolute;right:45px;top:5px;width:200px" class="w3-text w3-tag">Online help from GitHub
                </span>
                <img src="{{ url_for('static', filename='onlineHelp.png') }}" class="w3-image" id="onlinehelp" alt="Online help"
                    style="height:34px; width:34px" onclick="onlineHelp()">
            </div>
        </div>
    </div>
    {% if sc.lastSettingsTab == "settingsparams" %}
    <div id="settingsparams" class="settingsgroup">
    {% else %}
    <div id="settingsparams" class="settingsgroup" style="display:none">
    {% endif %}
        <h3>General Parameters</h3>
        <div>
            <form method="post" action="{{ url_for('settings.serverconfig') }}">
                <table class="w3-table-all">
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The camera used by the server.<br>
                                In case that multiple cameras are connected to the server device,
                                the active camera can be selected here
                            </span>
                            <label for="activecamera">Active Camera:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <select name="activecamera" id="activecamera">
                            {% for cam in cs %}
                                {% if cam.isUsb == false %}
                                {% if sc.activeCamera == cam.num %}
                                <option value="{{ cam.num }}" selected>{{ cam.num }}: {{ cam.model }}</option>
                                {% else %}
                                <option value="{{ cam.num }}">{{ cam.num }}: {{ cam.model }}</option>
                                {% endif %}
                                {% endif %}
                            {% endfor %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                If one or multiple microphones are accessible through PulseAudio, 
                                the description for the default microphone is shown.<br>
                                This will be the microphone used for audio recording.
                            </span>
                            <label for="defaultmic">Default Microphone:</label>
                        </td>
                        <td style="width:35%">
                            <input type="text" id="defaultmic" name="defaultmic" value="{{ sc.defaultMic }}" disabled>
                        </td>
                        <td style="width:35%">
                            {% if sc.isMicMuted == True %}
                            <input type="text" id="micmuted" name="micmuted" value="M U T E D" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Select whether audio shall be recorded along with videos.<br>
                                This is only available for selection if a microphone is connected 
                                and accessible through PulseAudio.
                            </span>
                            <label for="recordaudio">Record Audio along with Video:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            {% if sc.hasMicrophone == True %}
                            {% if sc.recordAudio == True %}
                            <input type="checkbox" id="recordaudio" name="recordaudio" aria-label="recordaudio" value="1"
                                checked>
                            {% else %}
                            <input type="checkbox" id="recordaudio" name="recordaudio" aria-label="recordaudio" value="0">
                            {% endif %}
                            {% else %}
                            <input type="checkbox" id="recordaudio" name="recordaudio" aria-label="recordaudio" value="0" disabled>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The time shift in seconds to apply between the audio and video streams.<br>
                                This may need tweaking to improve the audio/video synchronisation.
                            </span>
                            <label for="audiosync">Audio Timeshift [sec]:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <input type="number" id="audiosync" name="audiosync" min="-2.00" max="2.00" step="0.01" value="{{ sc.audioSync }}">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The system path where photos and videos will be stored.
                            </span>
                            <label for="photopath">Path for Photos/Videos:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <input style="width:70%" type="text" id="photopath" name="photopath" value="{{ sc.photoRoot }}/{{ sc.cameraPhotoSubPath }}" disabled>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The file format to be used for photos
                            </span>
                            <label for="phototype">Photo Type:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <select name="phototype" id="phototype">
                                {% if sc.photoType == "jpeg" %}
                                <option value="jpeg" selected>jpeg</option>
                                {% else %}
                                <option value="jpeg">jpeg</option>
                                {% endif %}
                                {% if sc.photoType == "jpg" %}
                                <option value="jpg" selected>jpg</option>
                                {% else %}
                                <option value="jpg">jpg</option>
                                {% endif %}
                                {% if sc.photoType == "bmp" %}
                                <option value="bmp" selected>bmp</option>
                                {% else %}
                                <option value="bmp">bmp</option>
                                {% endif %}
                                {% if sc.photoType == "png" %}
                                <option value="png" selected>png</option>
                                {% else %}
                                <option value="png">png</option>
                                {% endif %}
                                {% if sc.photoType == "gif" %}
                                <option value="gif" selected>gif</option>
                                {% else %}
                                <option value="gif">gif</option>
                                {% endif %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The file format to be used for raw photos
                            </span>
                            <label for="rawphototype">Raw Type:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <select name="rawphototype" id="rawphototype">
                                {% if sc.rawPhotoType == "dng" %}
                                <option value="dng" selected>dng</option>
                                {% else %}
                                <option value="dng">dng</option>
                                {% endif %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The file format to be used for videos
                            </span>
                            <label for="videotype">Video Type:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <select name="videotype" id="videotype">
                                {% if sc.videoType == "h264" %}
                                <option value="h264" selected>h264</option>
                                {% else %}
                                <option value="h264">h264</option>
                                {% endif %}
                                {% if sc.videoType == "mp4" %}
                                <option value="mp4" selected>mp4</option>
                                {% else %}
                                <option value="mp4">mp4</option>
                                {% endif %}
                            </select>
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Select whether you want to see histograms along with specific photo series.
                            </span>
                            <label for="showhistograms">Show Histograms:</label>
                        </td>
                        <td style="width:35%">
                            {% if sc.supportsHistograms == True %}
                            {% if sc.useHistograms == True %}
                            <input type="checkbox" id="showhistograms" name="showhistograms" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="showhistograms" name="showhistograms" value="0">
                            {% endif %}
                            {% else %}
                            <input type="checkbox" id="showhistograms" name="showhistograms" value="0" disabled>
                            {% endif %}
                        </td>
                        <td style="width:35%">
                        {% if sc.supportsHistograms == False %}
                            <p style="margin-top:0; margin-bottom:0">{{ sc.whyNotSupportsHistograms|safe }}</p>
                        {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                This indicates whether advanced algorithms can be used for motion detection:<br>
                                Frame Differencing, Optical Flow, Background Subtraction
                            </span>
                            <label for="supportsextmotiondetection">Ext. Motion Detection supported:</label>
                        </td>
                        <td style="width:35%">
                            {% if sc.supportsExtMotionDetection == True %}
                            <input type="checkbox" id="supportsextmotiondetection" name="supportsextmotiondetection" value="1" checked disabled>
                            {% else %}
                            <input type="checkbox" id="supportsextmotiondetection" name="supportsextmotiondetection" value="0" disabled>
                            {% endif %}
                        </td>
                        <td style="width:35%">
                        {% if sc.supportsExtMotionDetection == False %}
                            <p style="margin-top:0; margin-bottom:0">{{ sc.whyNotsupportsExtMotionDetection|safe }}</p>
                        {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Select whether streaming requires authentication.
                            </span>
                            <label for="requireAuthForStreaming">Req. Auth for Streaming:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            {% if sc.requireAuthForStreaming == True %}
                            <input type="checkbox" id="requireAuthForStreaming" name="requireAuthForStreaming" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="requireAuthForStreaming" name="requireAuthForStreaming" value="0">
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Select whether you want to allow API access to the raspiCamSrv server.
                            </span>
                            <label for="useapi">Allow access through API:</label>
                        </td>
                        <td style="width:35%">
                            {% if sc.supportsAPI == True %}
                            {% if sc.useAPI == True %}
                            <input type="checkbox" id="useapi" name="useapi" onchange="confirmApiChange()" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="useapi" name="useapi" onchange="confirmApiChange()" value="0">
                            {% endif %}
                            {% else %}
                            <input type="checkbox" id="useapi" name="useapi" value="0" disabled>
                            {% endif %}
                        </td>
                        <td style="width:35%">
                            {% if sc.supportsAPI == False %}
                            <p style="margin-top:0; margin-bottom:0">{{ sc.whyNotSupportsAPI|safe }}</p>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Geographic Latitude of camera position.<br>
                                (Required for sunrise/sunset calculation)
                            </span>
                            <label for="loclatitude">Latitude:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <input type="number" id="loclatitude" name="loclatitude" min="-90.000000" max="90.000000" step="0.000001"
                                value="{{ sc.locLatitude }}">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Geographic Longitude of camera position.<br>
                                (Required for sunrise/sunset calculation)
                            </span>
                            <label for="loclongitude">Longitude:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <input type="number" id="loclongitude" name="loclongitude" min="-180.000000" max="180.000000" step="0.000001"
                                value="{{ sc.locLongitude }}">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Geographic Elevation of camera position (in m).<br>
                                (Required for sunrise/sunset calculation)
                            </span>
                            <label for="locelevation">Elevation:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <input type="number" id="locelevation" name="locelevation" min="-1000.0" max="9000.0" step="0.1"
                                value="{{ sc.locElevation }}">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:5%">
                        </td>
                        <td style="width:25%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Time zone of camera position.<br>
                                (Required for sunrise/sunset calculation)
                            </span>
                            <label for="loctzkey">Time Zone:</label>
                        </td>
                        <td style="width:70%" colspan="2">
                            <select name="loctzkey" id="loctzkey">
                                {% for tz in sc.timeZoneKeys() %}
                                {% if sc.locTzKey == tz %}
                                <option value="{{ tz }}" selected>{{ tz }}</option>
                                {% else %}
                                <option value="{{ tz }}">{{ tz }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </tr>
                </table>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" type="submit" value="Submit">
            </form>
        </div>
    </div>
    {% if sc.lastSettingsTab == "settingsconfig" %}
    <div id="settingsconfig" class="settingsgroup">
    {% else %}
    <div id="settingsconfig" class="settingsgroup" style="display:none">
    {% endif %}
        <h3>Configuration Management</h3>
        <table>
            <tr>
                <td>
                    <form id="storeconfig" method="post" action="{{ url_for('settings.store_config') }}">
                        <input class="w3-button w3-black" style="width: 22ch" type="submit" onclick="confirmStore('storeconfig')" value="Store Configuration">
                    </form>
                </td>
                <td>
                    <form id="loadconfig" method="post" action="{{ url_for('settings.load_config') }}">
                        <input class="w3-button w3-black" style="width: 26ch" type="submit"  onclick="confirmLoad('loadconfig')" value="Load Stored Configuration">
                    </form>
                </td>
                <td>
                    <form id="resetserver" method="post" action="{{ url_for('settings.resetServer') }}">
                        <input class="w3-button w3-black" style="width: 16ch" type="submit"  onclick="confirmReset('resetserver')" value="Reset Server">
                    </form>
                </td>
                <!--
                <td>
                    <form id="shutdownserver" method="post" action="{{ url_for('settings.shutdown') }}">
                        <input class="w3-button w3-black" style="width: 20ch" type="submit" onclick="confirmShutdown('shutdownserver')"
                            value="Shutdown Server">
                    </form>
                </td>
                -->
                <td style="width:25%" class="w3-tooltip">
                    <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                        If selected, the system will load the stored configuration on server start.<br>
                        Otherwise, the default configuration will be applied.
                    </span>
                    <label for="loadconfigonstartcb">Start server with stored Configuration:</label>
                </td>
                <td>
                    <form id="loadconfigonstart" method="post" action="{{ url_for('settings.loadConfigOnStart') }}">
                        {% if los == True %}
                        <input type="checkbox" id="loadconfigonstartcb" name="loadconfigonstartcb" onchange="loadCfgOnStart('loadconfigonstart')" value="1" checked>
                        {% else %}
                        <input type="checkbox" id="loadconfigonstartcb" name="loadconfigonstartcb" onchange="loadCfgOnStart('loadconfigonstart')" value="0">
                        {% endif %}
                    </form>
                </td>
            </tr>
        </table>
        <h3>Unsaved Configuration Changes:</h3>
        <div style="max-height:65vh;overflow-y:auto">
            <table class="w3-table-all">
                <thead>
                    <tr>
                        <th style="width:20%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                            Time
                        </th>
                        <th style="width:80%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                            Action
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in sc.changeLog %}
                    <tr>
                        <td style="width:20%">
                            {{ entry["time"].strftime("%Y-%m-%d %H:%M:%S") }}
                        </td>
                        <td style="width:80%">
                            {{ entry["entry"] }}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
    {% if sc.lastSettingsTab == "settingsusers" %}
    <div id="settingsusers" class="settingsgroup">
    {% else %}
    <div id="settingsusers" class="settingsgroup" style="display:none">
    {% endif %}
        {% set activeuser = g.user %}
        {% if activeuser["issuperuser"] == 1 %}
        <h3>Users</h3>
        <div>
            <form id="removeusersform" method="post" action="{{ url_for('settings.remove_users') }}">
                <table class="w3-table-all">
                    <tr>
                        <th>
                            Sel
                        </th>
                        <th>
                            ID
                        </th>
                        <th>
                            Name
                        </th>
                        <th>
                            Initial
                        </th>
                        <th>
                            SuperUser
                        </th>
                    </tr>
                    {% for user in g.users %}
                    <tr>
                        <td style="width:5%">
                            <input type="checkbox" id="sel_{{ user['id'] }}" name="sel_{{ user['id'] }}"
                                aria-label="sel_{{ user['id'] }}" value="0">
                        </td>
                        <td>
                            {{ user["id"] }}
                        </td>
                        <td>
                            {{ user["username"] }}
                        </td>
                        <td>
                            {% if 'isinitial' is in user %}
                            {% if user["isinitial"] == 0 %}
                            No
                            {% else %}
                            Yes
                            {% endif %}
                            {% else %}
                            Unknown
                            {% endif %}
                        </td>
                        <td>
                            {% if 'issuperuser' is in user %}
                            {% if user["issuperuser"] == 0 %}
                            No
                            {% else %}
                            Yes
                            {% endif %}
                            {% else %}
                            Unknown
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" style="width: 22ch" type="submit" onclick="confirmRemove('removeusersform')" value="Remove Selected Users">
                <p style="margin-bottom: 0"></p>
            </form>
            <form method="post" action="{{ url_for('settings.register_user') }}">
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" style="width: 22ch" type="submit" value="Register New User">
            </form>
            {% set user = g.users[0] %}
            {% if not 'issuperuser' is in user %}
            <p>
                You are using an outdated database schema for users.<br>
                To update to the new schema, run the following command in raspi-cam-srv, 
                with activated virtual environment:<br>
                flask --app raspiCamSrv init-db
            </p>
            {% endif %}
        </div>
        <br>
        {% endif %}
    </div>
    {% if sc.useAPI == True %}
    {% if sc.lastSettingsTab == "settingsapi" %}
    <div id="settingsapi" class="settingsgroup">
    {% else %}
    <div id="settingsapi" class="settingsgroup" style="display:none">
    {% endif %}
        <div>
            <h3>API Settings</h3>
            <p>API access to the rapiCamSrv server is secured through JSON Web Tokens (JWT).</p>
            <p>JWT requires a secret private key for signing tokens<br>
               In order to enable API access, you need to specify the path of the secrets file 
               where the secret key will be stored.<br>
               It is recommended using the following path:<br>
               /home/%user%/.secrets/raspiCamSrv.secrets
            </p>
            <p>Furthermore, you can specify expiration for the access token.</p>
            <p>In case that the access token will expire, 
                also the expiration period for the refresh token needs to be specified</p>
            {% if sc.API_active == True %}
            {% if sc.jwtAuthenticationActive == True %}
            <h3 class="w3-green">raspiCamSrv API is active</h3>
            {% else %}
            {% if sc.jwtKeyStore|length == 0 %}
            <h3 class="w3-yellow">To deactivate the API, store configuration and restart server with stored configuration</h3>
            {% else %}
            <h3 class="w3-yellow">To update token expiration, store configuration and restart server with stored configuration</h3>
            {% endif %}
            {% endif %}
            {% else %}
            {% if sc.jwtAuthenticationActive == False %}
            <h3 class="w3-red">API not active. Please specify JWT authentication settings</h3>
            {% else %}
            <h3 class="w3-yellow">To activate the API, store configuration and restart server with stored configuration</h3>
            {% endif %}
            {% endif %}
            <form method="post" action="{{ url_for('settings.api_config') }}">
                <table class="w3-table-all">
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Full path to secrets file 
                                for storage of secret key for JWT authentication.<br>
                                A blank value will deactivate the API.
                            </span>
                            <label for="jwtkeystore">JWT Secret Key File Path:</label>
                        </td>
                        <td style="width:50%">
                            <input style="width: 100%" type="text" id="jwtkeystore" name="jwtkeystore"
                                value="{{ sc.jwtKeyStore }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Expiration time (in minutes) for the short-lived access token.<br>
                                0 = no expiration
                            </span>
                            <label for="jwtaccesstokenexpirationmin">Access Token Expiration in Minutes:</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="jwtaccesstokenexpirationmin" name="jwtaccesstokenexpirationmin" min="0" max="999999" step="1"
                                value="{{ sc.jwtAccessTokenExpirationMin }}">
                        </td>
                    </tr>
                    <tr>
                        <td class="w3-tooltip" style="width:50%">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Expiration time (in days) for the long-lived refresh token,
                                which can be used to refresh the access token.<br>
                                0 = no expiration
                            </span>
                            <label for="jwtrefreshtokenexpirationdays">Refresh Token Expiration in Days:</label>
                        </td>
                        <td style="width:50%">
                            <input type="number" id="jwtrefreshtokenexpirationdays" name="jwtrefreshtokenexpirationdays" min="0" max="999999"
                                step="1" value="{{ sc.jwtRefreshTokenExpirationDays }}">
                        </td>
                    </tr>
                </table>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" type="submit" value="Submit">
            </form>
            <p>&nbsp;</p>
            <table style="width: 100%">
                <tr>
                    <td>
                        <form id="generatetoken" method="post" action="{{ url_for('settings.generate_token') }}">
                            <input class="w3-button w3-black" style="width: 30ch" type="submit"
                                onclick="doSubmit('generatetoken')" value="Generate Access Token">
                        </form>
                    </td>
                </tr>
                {% if access_token|length > 0 %}
                <tr style="width: 100%">
                    <td>
                        <form>
                            <textarea id="jwttoken" name="jwttoken" rows="5" style="width: 100%" class="w3-input w3-border" disabled>
                                {{ access_token }}
                            </textarea>
                        </form>
                    </td>
                </tr>
                {% endif %}
            </table>
        </div>
    </div>
    {% endif %}
    {% if sc.lastSettingsTab == "settingsvbuttons" %}
    <div id="settingsvbuttons" class="settingsgroup">
    {% else %}
    <div id="settingsvbuttons" class="settingsgroup" style="display:none">
    {% endif %}
        <h3>Versatile Buttons</h3>
        <p>
            On this page you can configure the versatile buttons shown under Console/Versatile Buttons.<br>
            Buttons are arranged in a matrix-like structure with rows and columns.<br>
        </p>
        <div>
            <table style="width:100%" id="vbuttondimtab">
                <form id="vbuttondimensions" method="post" action="{{ url_for('settings.vbutton_dimensions') }}">
                    <tr>
                        <td style="width: 15%">
                            Number of Rows:
                        </td>
                        <td style="width: 5%">
                            <input type="number" id="vbuttonsrows" name="vbuttonsrows" min="0" max="99" step="1" 
                                value="{{ sc.vButtonsRows }}">
                        </td>
                        <td style="width: 15%">
                            Number of Columns:
                        </td>
                        <td style="width: 5%">
                            <input type="number" id="vbuttonscols" name="vbuttonscols" min="0" max="99" step="1"
                            value="{{ sc.vButtonsCols }}">
                        </td>
                        <td style="width: 17%">
                            Interactive Commandline:
                        </td>
                        <td style="width:5%">
                            {% if sc.vButtonHasCommandLine == True %}
                            <input type="checkbox" id="vbuttonhascommandline"
                                name="vbuttonhascommandline" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="vbuttonhascommandline"
                                name="vbuttonhascommandline" value="1">
                            {% endif %}
                        </td>
                        <td style="width: 5%">
                        </td>
                        <td style="width: 20%">
                            <input class="w3-button w3-black" type="submit" value="Submit">
                        </td>
                        <td style="width: 13%">
                        </td>
                    </tr>
                </form>
            </table>
        </div>
        {% if sc.vButtonsRows == 0 or sc.vButtonsCols == 0 %}
        <div style="display:none">
        {% else %}
        <div>
        {% endif %}
            <h3>Button Settings</h1>
            <div>
                <form method="post" action="{{ url_for('settings.vbutton_settings') }}">
                    <div style="max-height:63.6vh;overflow-y:auto">
                        <table class="w3-table-all">
                            <thead>
                                <tr>
                                    <th style="width:5%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Row
                                    </th>
                                    <th style="width:5%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Col
                                    </th>
                                    <th style="width:5%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Visible
                                    </th>
                                    <th style="width:5%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Shape
                                    </th>
                                    <th style="width:5%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Color
                                    </th>
                                    <th style="width:20%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Button Text
                                    </th>
                                    <th style="width:50%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Command
                                    </th>
                                    <th style="width:5%; width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                        Conf
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for r in sc.vButtons %}
                                {% for btn in r %}
                                <tr>
                                    <td style="width:5%">
                                        {{ btn["row"] + 1 }}
                                    </td>
                                    <td style="width:5%">
                                        {{ btn["col"] + 1 }}
                                    </td>
                                    <td style="width:5%">
                                        {% if btn["isVisible"] == True %}
                                        <input type="checkbox" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_visible" 
                                            name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_visible" value="1" checked>
                                        {% else %}
                                        <input type="checkbox" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_visible"
                                            name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_visible" value="1">
                                        {% endif %}
                                    </td>
                                    <td style="width:5%">
                                        <select name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_shape" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_shape">
                                            {% if btn["buttonShape"] == "Rectangle" %}
                                            <option value="Rectangle" selected>Rectangle</option>
                                            {% else %}
                                            <option value="Rectangle">Rectangle</option>
                                            {% endif %}
                                            {% if btn["buttonShape"] == "Rounded" %}
                                            <option value="Rounded" selected>Rounded</option>
                                            {% else %}
                                            <option value="Rounded">Rounded</option>
                                            {% endif %}
                                            {% if btn["buttonShape"] == "Circular" %}
                                            <option value="Circular" selected>Circular</option>
                                            {% else %}
                                            <option value="Circular">Circular</option>
                                            {% endif %}
                                            {% if btn["buttonShape"] == "Square" %}
                                            <option value="Square" selected>Square</option>
                                            {% else %}
                                            <option value="Square">Square</option>
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td style="width:5%">
                                        <select name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_color" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_color">
                                            {% if btn["buttonColor"] == "Black" %}
                                            <option value="Black" selected>Black</option>
                                            {% else %}
                                            <option value="Black">Black</option>
                                            {% endif %}
                                            {% if btn["buttonColor"] == "Red" %}
                                            <option value="Red" selected>Red</option>
                                            {% else %}
                                            <option value="Red">Red</option>
                                            {% endif %}
                                            {% if btn["buttonColor"] == "Green" %}
                                            <option value="Green" selected>Green</option>
                                            {% else %}
                                            <option value="Green">Green</option>
                                            {% endif %}
                                            {% if btn["buttonColor"] == "Yellow" %}
                                            <option value="Yellow" selected>Yellow</option>
                                            {% else %}
                                            <option value="Yellow">Yellow</option>
                                            {% endif %}
                                            {% if btn["buttonColor"] == "Blue" %}
                                            <option value="Blue" selected>Blue</option>
                                            {% else %}
                                            <option value="Blue">Blue</option>
                                            {% endif %}
                                        </select>
                                    </td>
                                    <td style="width:20%">
                                        <input style="width: 100%" type="text" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_buttontext"
                                            name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_buttontext" value="{{ btn['buttonText'] }}">
                                    </td>
                                    <td style="width:50%">
                                        <input style="width: 100%" type="text" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_buttonexec"
                                            name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_buttonexec" value="{{ btn['buttonExec'] }}">
                                    </td>
                                    <td style="width:5%">
                                        {% if btn["needsConfirm"] == True %}
                                        <input type="checkbox" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_confirm"
                                            name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_confirm" value="1" checked>
                                        {% else %}
                                        <input type="checkbox" id="vbtn_{{ btn['row'] }}{{ btn['col'] }}_confirm"
                                            name="vbtn_{{ btn['row'] }}{{ btn['col'] }}_confirm" value="1">
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <p style="margin-bottom: 0"></p>
                    <input class="w3-button w3-black" type="submit" value="Submit">
                </form>
            </div>
        </div>
    </div>
    {% if sc.lastSettingsTab == "settingsabuttons" %}
    <div id="settingsabuttons" class="settingsgroup">
    {% else %}
    <div id="settingsabuttons" class="settingsgroup" style="display:none">
    {% endif %}
        <h3>Action Buttons</h3>
        <p>
            On this page you can configure the action buttons shown under Console/Action Buttons.<br>
            With these buttons you can execute actions which are configured on page Trigger/Actions<br>
            Buttons are arranged in a matrix-like structure with rows and columns.<br>
        </p>
        <div>
            <table style="width:100%" id="abuttondimtab">
                <form id="abuttondimensions" method="post" action="{{ url_for('settings.abutton_dimensions') }}">
                    <tr>
                        <td style="width: 15%">
                            Number of Rows:
                        </td>
                        <td style="width: 5%">
                            <input type="number" id="abuttonsrows" name="abuttonsrows" min="0" max="99" step="1" 
                                value="{{ sc.abuttonsRows }}">
                        </td>
                        <td style="width: 15%">
                            Number of Columns:
                        </td>
                        <td style="width: 5%">
                            <input type="number" id="abuttonscols" name="abuttonscols" min="0" max="99" step="1"
                            value="{{ sc.abuttonsCols }}">
                        </td>
                        <td style="width: 17%">
                            <input class="w3-button w3-black" type="submit" value="Submit">
                        </td>
                        <td style="width:5%">
                        </td>
                        <td style="width: 5%">
                        </td>
                        <td style="width: 20%">
                        </td>
                        <td style="width: 13%">
                        </td>
                    </tr>
                </form>
            </table>
        </div>
        {% if sc.abuttonsRows == 0 or sc.abuttonsCols == 0 %}
        <div style="display:none">
        {% else %}
        <div>
        {% endif %}
            <h3>Action Button Settings</h1>
            <form method="post" action="{{ url_for('settings.abutton_settings') }}">
                <div style="max-height:63.6vh;overflow-y:auto">
                    <table class="w3-table-all">
                        <thead>
                            <tr>
                                <th style="width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Row
                                </th>
                                <th style="width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Col
                                </th>
                                <th style="width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Visible
                                </th>
                                <th style="width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Shape
                                </th>
                                <th style="width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Color
                                </th>
                                <th style="width:20%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Button Text
                                </th>
                                <th style="width:50%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Action
                                </th>
                                <th style="width:5%; position:sticky;top:0;z-index:1000; background-color: #f1f1f1;">
                                    Conf
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for r in sc.aButtons %}
                            {% for btn in r %}
                            <tr>
                                <td style="width:5%">
                                    {{ btn["row"] + 1 }}
                                </td>
                                <td style="width:5%">
                                    {{ btn["col"] + 1 }}
                                </td>
                                <td style="width:5%">
                                    {% if btn["isVisible"] == True %}
                                    <input type="checkbox" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_visible" 
                                        name="abtn_{{ btn['row'] }}{{ btn['col'] }}_visible" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_visible"
                                        name="abtn_{{ btn['row'] }}{{ btn['col'] }}_visible" value="1">
                                    {% endif %}
                                </td>
                                <td style="width:5%">
                                    <select name="abtn_{{ btn['row'] }}{{ btn['col'] }}_shape" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_shape">
                                        {% if btn["buttonShape"] == "Rectangle" %}
                                        <option value="Rectangle" selected>Rectangle</option>
                                        {% else %}
                                        <option value="Rectangle">Rectangle</option>
                                        {% endif %}
                                        {% if btn["buttonShape"] == "Rounded" %}
                                        <option value="Rounded" selected>Rounded</option>
                                        {% else %}
                                        <option value="Rounded">Rounded</option>
                                        {% endif %}
                                        {% if btn["buttonShape"] == "Circular" %}
                                        <option value="Circular" selected>Circular</option>
                                        {% else %}
                                        <option value="Circular">Circular</option>
                                        {% endif %}
                                        {% if btn["buttonShape"] == "Square" %}
                                        <option value="Square" selected>Square</option>
                                        {% else %}
                                        <option value="Square">Square</option>
                                        {% endif %}
                                    </select>
                                </td>
                                <td style="width:5%">
                                    <select name="abtn_{{ btn['row'] }}{{ btn['col'] }}_color" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_color">
                                        {% if btn["buttonColor"] == "Black" %}
                                        <option value="Black" selected>Black</option>
                                        {% else %}
                                        <option value="Black">Black</option>
                                        {% endif %}
                                        {% if btn["buttonColor"] == "White" %}
                                        <option value="White" selected>White</option>
                                        {% else %}
                                        <option value="White">White</option>
                                        {% endif %}
                                        {% if btn["buttonColor"] == "Red" %}
                                        <option value="Red" selected>Red</option>
                                        {% else %}
                                        <option value="Red">Red</option>
                                        {% endif %}
                                        {% if btn["buttonColor"] == "Green" %}
                                        <option value="Green" selected>Green</option>
                                        {% else %}
                                        <option value="Green">Green</option>
                                        {% endif %}
                                        {% if btn["buttonColor"] == "Yellow" %}
                                        <option value="Yellow" selected>Yellow</option>
                                        {% else %}
                                        <option value="Yellow">Yellow</option>
                                        {% endif %}
                                        {% if btn["buttonColor"] == "Blue" %}
                                        <option value="Blue" selected>Blue</option>
                                        {% else %}
                                        <option value="Blue">Blue</option>
                                        {% endif %}
                                    </select>
                                </td>
                                <td style="width:20%">
                                    <input style="width: 100%" type="text" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_buttontext"
                                        name="abtn_{{ btn['row'] }}{{ btn['col'] }}_buttontext" value="{{ btn['buttonText'] }}">
                                </td>
                                <td style="width:50%">
                                    <select name="abtn_{{ btn['row'] }}{{ btn['col'] }}_action" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_action">
                                        {% if btn["buttonAction"] == "" %}
                                        <option value="" selected></option>
                                        {% else %}
                                        <option value=""></option>
                                        {% endif %}
                                        {% for action in tc.actions %}
                                        {% if btn["buttonAction"] == action.id %}
                                        <option value="{{ action.id }}" selected>{{ action.id }}</option>
                                        {% else %}
                                        <option value="{{ action.id }}">{{ action.id }}</option>
                                        {% endif %}
                                        {% endfor %}
                                    </select>
                                </td>
                                <td style="width:5%">
                                    {% if btn["needsConfirm"] == True %}
                                    <input type="checkbox" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_confirm"
                                        name="abtn_{{ btn['row'] }}{{ btn['col'] }}_confirm" value="1" checked>
                                    {% else %}
                                    <input type="checkbox" id="abtn_{{ btn['row'] }}{{ btn['col'] }}_confirm"
                                        name="abtn_{{ btn['row'] }}{{ btn['col'] }}_confirm" value="1">
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <p style="margin-bottom: 0"></p>
                <input class="w3-button w3-black" type="submit" value="Submit">
            </form>
        </div>
    </div>
    {% if sc.lastSettingsTab == "settingsdevices" %}
    <div id="settingsdevices" class="settingsgroup">
    {% else %}
    <div id="settingsdevices" class="settingsgroup" style="display:none">
    {% endif %}
        <div class="w3-row">
            <div class="w3-half">
                <h3>GPIO-Connected Devices</h3>
                <h4>New Device</h4>
                <table>
                    <form method="post" id="newdevice" action="{{ url_for('settings.new_device') }}">
                        <tr>
                            <td class="w3-tooltip" style="width:35%">
                                <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                    Select one of the available device types.<br>
                                    raspiCamSrv supports various gpizero device types.
                                </span>
                                <label for="newdevicetype">Device Type:</label>
                            </td>
                            <td style="width:35%">
                                {% set urlStatic = url_for('static', filename='' ) %}
                                <select style="width:100%; height:28px" name="newdevicetype" id="newdevicetype"
                                        onchange="changeDeviceTypeImage('newdevicetype', 'deviceimage', '{{ urlStatic }}')">
                                    {% if sc.curDeviceType %}
                                    {% set curDeviceType = sc.curDeviceType.type %}
                                    {% for devicetype in sc.deviceTypes %}
                                    {% if devicetype.type == curDeviceType %}
                                    <option value="{{ devicetype.type}}" selected>{{ devicetype.type }}</option>
                                    {% else %}
                                    <option value="{{ devicetype.type}}">{{ devicetype.type }}</option>
                                    {% endif %}
                                    {% endfor %}
                                    {% else %}
                                    {% for devicetype in sc.deviceTypes %}
                                    <option value="{{ devicetype.type}}">{{ devicetype.type }}</option>
                                    {% endfor %}
                                    {% endif %}
                                </select>
                            </td>
                            <td style="width:30%">
                                <!-- This cell is used to store an invisible list of device type images -->
                                {% for deviceType in sc.deviceTypes %}
                                {% if "image" in deviceType %}
                                <p id="devicetypeimage_{{ deviceType.type }}" style="display:none">{{ deviceType.image }}</p>
                                {% endif%}
                                {% endfor%}
                            </td>
                        </tr>
                        <tr>
                            <td class="w3-tooltip" style="width:35%">
                                <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                    Enter a unique ID under which the new device will be identified
                                    within the system.
                                </span>
                                <label for="newdeviceid">ID:</label>
                            </td>
                            <td style="width:35%">
                                <input type="text" id="newdeviceid" name="newdeviceid" value="" aria-label="ID for device">
                            </td>
                            <td style="width:30%">
                                <input class="w3-button w3-black" style="width:95px" type="submit" value="Create">
                            </td>
                        </tr>
                    </form>
                </table>
            </div>
            <div class="w3-half">
                {% if sc.curDeviceType %}
                {% set devImage = sc.curDeviceType.image %}
                {% else %}
                {% set devType = sc.deviceTypes[0] %}
                {% set devImage = devType.image %}
                {% endif %}
                {% if devImage %}
                {% if devImage|length() > 0 %}
                {% set urlImage=url_for('static', filename=devImage) %}
                <img src="{{ urlImage }}" class="w3-image" id="deviceimage" alt="Device image"
                    style="height:200px; object-fit:scale-down">
                {% endif %}
                {% endif %}
            </div>
        </div>
        <div class="w3-row">
            <hr>
        </div>
        {% if sc.gpioDevices|length() > 0 %}
        <div class="w3-half">
            <h3>Device Configuration</h3>
            <table>
                <tr>
                    {% if sc.curDeviceId != "" %}
                    <form method="post" id="device" action="{{ url_for('settings.select_device') }}">
                        <td style="width:35%">
                        </td>
                        <td style="width:35%">
                            <select style="width:100%; height:28px" name="selectdevice" id="selectdevice" onchange="doSubmit('device')">
                                {% for device in sc.gpioDevices %}
                                {% if device.id == sc.curDeviceId %}
                                <option value="{{ device.id }}" selected>{{ device.id }}</option>
                                {% else %}
                                <option value="{{ device.id }}">{{ device.id }}</option>
                                {% endif %}
                                {% endfor %}
                            </select>
                        </td>
                    </form>
                    <td style="width:30%">
                        <form method="post" id="deletedevice" action="{{ url_for('settings.delete_device') }}">
                            <input class="w3-button w3-black" style="width:95px" type="submit" value="Delete"
                                onclick="confirmDeleteDevice('deletedevice')">
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% if sc.curDeviceId != "" %}
                {% set device = sc.curDevice %}
                <form method="post" id="deviceprops" action="{{ url_for('settings.device_properties') }}">
                    <tr>
                        <td style="width:35%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The status shows whether or not a device has been completely configured 
                                and tested so that it can be used.
                            </span>
                            <label for="devicestatus">Config Status:</label>
                        </td>
                        <td style="width:35%">
                            {% if device.isOk == True %}
                            <input style="width:100%" type="text" id="devicestatus" name="devicestatus" value="OK" disabled>
                            {% else %}
                            <input style="width:100%" type="text" id="devicestatus" name="devicestatus" value="Not OK" disabled>
                            {% endif %}
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:35%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                The device type is one of the supported gpiozero device types.
                            </span>
                            <label for="devicetype">Device Type:</label>
                        </td>
                        <td style="width:35%">
                            <input style="width:100%" type="text" id="devicetype" name="devicetype" value="{{ device.type }}" disabled>
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:35%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                Usage shows whether the device is an input or output device.
                            </span>
                            <label for="deviceusage">Usage:</label>
                        </td>
                        <td style="width:35%">
                            <input style="width:100%" type="text" id="deviceusage" name="deviceusage" value="{{ device.usage }}" disabled>
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    <tr>
                        <td style="width:35%" class="w3-tooltip">
                            <span style="position:absolute;left:0;bottom:30px" class="w3-text w3-tag">
                                gpiozero documentation for this device type.
                            </span>
                            <label for="devicedocurl">gpiozero Doc:</label>
                        </td>
                        <td style="width:35%">
                            <a id="devicedocurl" href="{{ device.docUrl }}" target="_blank">Link to gpiozero</a>
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                    {% set deviceType = sc.curDeviceType %}
                    {% for key, value in device.params.items() %}
                    {% for dtKey, dtValue in deviceType.params.items() %}
                    {% if key == dtKey %}
                    <tr>
                        <td style="width:35%">
                            {{ key }}
                        </td>
                        {% if dtValue.type == "str" %}
                        <td style="width:35%">
                            <input type="text" id="param_{{ key }}" name="param_{{ key }}" value="{{ value }}">
                        </td>
                        {% elif dtValue.type == "int"%}
                        <td style="width:35%">
                            <input type="number" id="param_{{ key }}" name="param_{{ key }}" min="{{ dtValue.min }}" max="{{ dtValue.max }}"
                                step="1" value="{{ value }}">
                        </td>
                        {% elif dtValue.type == "float"%}
                        <td style="width:35%">
                            <input type="number" id="param_{{ key }}" name="param_{{ key }}" min="{{ dtValue.min }}" max="{{ dtValue.max }}"
                                step="0.001" value="{{ value }}">
                        </td>
                        {% elif dtValue.type == "floatOrNone"%}
                        <td style="width:35%">
                            <input type="text" id="param_{{ key }}" name="param_{{ key }}" value="{{ value }}">
                        </td>
                        {% elif dtValue.type == "bool"%}
                        <td style="width:35%">
                            {% if value == True %}
                            <input type="checkbox" id="param_{{ key }}" name="param_{{ key }}" value="1" checked>
                            {% else %}
                            <input type="checkbox" id="param_{{ key }}" name="param_{{ key }}" value="1">
                            {% endif %}
                        </td>
                        {% elif dtValue.type == "boolOrNone"%}
                        <td style="width:35%">
                            <select style="width:100%; height:28px" name="param_{{ key }}" id="param_{{ key }}">
                                {% if value is none %}
                                <option value="None" selected>None</option>
                                {% else %}
                                <option value="None">None</option>
                                {% endif %}
                                {% if value == True %}
                                <option value="True" selected>True</option>
                                {% else %}
                                <option value="True">True</option>
                                {% endif %}
                                {% if value == False %}
                                <option value="False" selected>False</option>
                                {% else %}
                                <option value="False">False</option>
                                {% endif %}
                            </select>
                        </td>
                        {% else %}
                        <td style="width:35%">
                            <input type="text" id="param_{{ key }}" name="param_{{ key }}" value="{{ value }}">
                        </td>
                        {% endif %}
                    </tr>
                    {% endif %}
                    {% endfor %}
                    {% endfor %}
                    <tr>
                        <td style="width:35%">
                            <input class="w3-button w3-black" type="submit" value="Submit">
                        </td>
                        <td style="width:35%">
                        </td>
                        <td style="width:30%">
                        </td>
                    </tr>
                </form>
                {% endif %}
            </table>
            {% set device = sc.curDevice %}
            {% if device.isOk == True %}
            <hr>
            {% if device.needsCalibration == True %}
            <h3>Device Test & Calibration</h3>
            {% else %}
            <h3>Device Test</h3>
            {% endif %}
            <table style="table-layout: fixed; width:100%">
                <tr>
                    <td style="width:25%">
                        <form method="post" id="testdevice" action="{{ url_for('settings.test_device') }}">
                            <input class="w3-button w3-black" style="width:95px" type="submit" value="Test" onclick="hideTestResults()">
                        </form>
                    </td>
                    <td style="width:25%">
                        {% if device.needsCalibration == True %}
                        <form method="post" id="calibratedevice" action="{{ url_for('settings.calibrate_device') }}">
                            <input class="w3-button w3-black" style="width:95px" type="submit" value="Calibrate" onclick="hideTestResults()">
                        </form>
                        {% endif %}
                    </td>
                    {% if device.isCalibrating == True %}
                    <td style="width:10%">
                        <a href="{{ url_for('settings.calibrate_fbwd') }}" class="w3-button w3-sand">&laquo;</a>
                    </td>
                    <td style="width:10%">
                        <a href="{{ url_for('settings.calibrate_bwd') }}" class="w3-button w3-sand">&lt</a>
                    </td>
                    <td style="width:10%">
                        <a href="{{ url_for('settings.docalibrate') }}" class="w3-button w3-sand">OK</a>
                    </td>
                    <td style="width:10%">
                        <a href="{{ url_for('settings.calibrate_fwd') }}" class="w3-button w3-sand">&gt</a>
                    </td>
                    <td style="width:10%">
                        <a href="{{ url_for('settings.calibrate_ffwd') }}" class="w3-button w3-sand">&raquo;</a>
                    </td>
                    {% else %}
                    <td style="width:50%">
                    </td>
                    {% endif %}
                </tr>
            </table>
            {% if result|length() > 0 %}
            <div style="height:200px; overflow: auto">
                <table id="testresults" class="w3-table-all">
                    {% for key, value in result.items() %}
                    <tr>
                        <td style="width:35%">
                            {{ key }}
                        </td>
                        <td colspan="2" style="width:65%">
                            {{ value }}
                        </td>
                    </tr>
                    {% endfor %}
                </table>
            </div>
            {% endif %}
            {% endif %}
        </div>
        {% endif %}
        {% if sc.gpioDevices|length() > 0 %}
        <div class="w3-half">
            <h3>Devices</h3>
            <p>
                Unused GPIO Pins:
                {% for pin in sc.freeGpioPins %}{{ pin }}{% if not loop.last %},{% endif %}{% endfor %}
            </p>
            <div style="max-height:58.5vh;overflow-y:auto">
                <table class="w3-table-all">
                    <thead>
                        <tr>
                            <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                ID
                            </th>
                            <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                Type
                            </th>
                            <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                Usage
                            </th>
                            <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                GPIO Pins
                            </th>
                            <th style="position:sticky;top:0;z-index:10; background-color: #f1f1f1;">
                                OK
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for device in sc.gpioDevices %}
                        <tr>
                            <td>
                                {{ device.id }}
                            </td>
                            <td>
                                {{ device.type }}
                            </td>
                            <td>
                                {{ device.usage }}
                            </td>
                            <td>
                                {{ device.usedPins }}
                            </td>
                            <td>
                                {{ device.isOk }}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
        {% endif %}
    </div>
    
    <script>
        var deviceTypeImages;

        function initDeviceTypeImages(){
            deviceTypeImages = new Map();
        }

        function appendDeviceTypeImages(type, image){
            deviceTypeImages.set(type, image);
        }

        function openSettingsTab(settingsTabName, settingsTabButton) {
            var i;
            var x = document.getElementsByClassName("settingsgroup");
            for (i = 0; i < x.length; i++) {
                x[i].style.display = "none";
            }
            document.getElementById(settingsTabName).style.display = "block";

            var b = document.getElementsByClassName("settingsmenu");
            for (i = 0; i < b.length; i++) {
                b[i].classList = "w3-bar-item w3-button settingsmenu";
            }
            document.getElementById(settingsTabButton).classList = "w3-bar-item w3-button settingsmenu w3-light-green";
        }
        function confirmRemove(form) {
            if (confirm("Do you want to remove the selected users?")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }
        function confirmReset(form) {
            if (confirm("Do you want to reset the server?\nThe entire configuration will be reset to default!")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }
        function confirmShutdown(form) {
            if (confirm("Do you want to shut down the server?\nIf the server is running as service, it will restart automatically.\nOtherwise, you need to start it manually")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }
        function confirmStore(form) {
            if (confirm("Do you want to replace the stored configuration with the current configuration?")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }
        function confirmLoad(form) {
            if (confirm("Do you want to replace the current configuration with the stored configuration?")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }
        function confirmApiChange(form) {
            confirm("A change of API usage will only be effective for clients if you save the configuration and restart the server with stored configuration.")
        }
        function loadCfgOnStart(form) {
                document.getElementById(form).submit();
        }
        function doSubmit(form) {
            document.getElementById(form).submit();
        }
        function onlineHelp() {
            window.open("https://github.com/signag/raspi-cam-srv/blob/main/docs/Settings.md");
        }
        function confirmDeleteDevice(form) {
            if (confirm("Do you want to delete this device?")) {
                document.getElementById(form).method = "post";
                document.getElementById(form).submit();
            } else {
                document.getElementById(form).method = "get";
            }
        }
        function changeDeviceTypeImage(src, tgt, urlRoot){
            deviceType = document.getElementById(src).value;
            imgId = "devicetypeimage_" + deviceType;
            image = document.getElementById(imgId).innerText;
            file = urlRoot + image;
            tgtEl = document.getElementById(tgt);
            tgtEl.src = file
        }
        function hideTestResults(){
            tr = document.getElementById("testresults")
            tr.display = "none"
        }
    </script>

{% endblock %}